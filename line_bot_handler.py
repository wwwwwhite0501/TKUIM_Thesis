import asyncio
from fastapi import HTTPException
from linebot import WebhookHandler, LineBotApi
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
from db import (
    get_db_connection, get_device_id, get_user_by_line_id,
    create_user_if_not_exists, map_user_to_device, list_devices_by_user,
    get_today_logs_for_user
)
from config import LINE_CHANNEL_ACCESS_TOKEN, LINE_CHANNEL_SECRET
from audio_processor import pause_device

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

def handle_line_message_sync(body, signature):
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        raise HTTPException(status_code=400, detail="Invalid signature")
    except Exception as e:
        print(f"LINE handler error: {e}")
        raise HTTPException(status_code=500, detail="LINE handler error")

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_id = event.source.user_id
    msg = event.message.text.strip()

    #æš«åœåµæ¸¬60ç§’ï¼ˆé‡å°è©²ä½¿ç”¨è€…ç¶å®šçš„æ‰€æœ‰è£ç½®ï¼‰
    if msg in ["æš«åœåµæ¸¬", "æš«åœåµæ¸¬60ç§’", "æš«åœ", "pause"]:
        db = get_db_connection()
        cur = db.cursor(dictionary=True)
        u = get_user_by_line_id(cur, user_id)
        if not u:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="æ‚¨å°šæœªåŠ å…¥ä»»ä½•è£ç½®"))
            db.close()
            return
        serials = list_devices_by_user(cur, u['id'])
        for serial in serials:
            pause_device(serial, seconds=60)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text="â¸é–‹å§‹æš«åœåµæ¸¬60ç§’"))
        db.close()
        return

    db = get_db_connection()
    cursor = db.cursor(dictionary=True)

    # åŠ å…¥è£ç½®
    if msg.startswith("åŠ å…¥"):
        device_code = msg.replace("åŠ å…¥", "").strip()
        cursor.execute("SELECT id FROM devices WHERE device_id = %s", (device_code,))
        device = cursor.fetchone()
        if not device:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="è£ç½®ä¸å­˜åœ¨"))
            db.close()
            return
        # å–å¾—æš±ç¨±
        try:
            profile = line_bot_api.get_profile(user_id)
            display_name = profile.display_name
        except Exception:
            display_name = "ç”¨æˆ¶"

        user = create_user_if_not_exists(db, cursor, user_id, display_name)
        added = map_user_to_device(db, cursor, device['id'], user['id'])
        if added:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"{display_name} å·²åŠ å…¥è£ç½® {device_code}"))
        else:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"ä½ å·²åŠ å…¥è£ç½® {device_code}"))
        db.close()
        return

    # é¡¯ç¤ºåºè™Ÿç™»å…¥æˆå“¡ / è£ç½®åˆ—è¡¨
    if msg in ["é¡¯ç¤ºåºè™Ÿç™»å…¥æˆå“¡", "é¡¯ç¤ºå·²åŠ å…¥è£ç½®", "è£ç½®åˆ—è¡¨"]:
        cursor.execute("SELECT id FROM users WHERE line_user_id = %s", (user_id,))
        user = cursor.fetchone()
        if not user:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="æ‚¨å°šæœªåŠ å…¥ä»»ä½•è£ç½®"))
            db.close()
            return

        cursor.execute("""
            SELECT d.device_id FROM devices d
            JOIN device_user_map m ON d.id = m.device_id
            WHERE m.user_id = %s
        """, (user['id'],))
        devices = cursor.fetchall()
        if not devices:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="æ‚¨å°šæœªåŠ å…¥ä»»ä½•è£ç½®"))
            db.close()
            return

        result_msg = "ä½ å·²åŠ å…¥çš„è£ç½®ï¼š\n"
        for device in devices:
            result_msg += f"\nåºè™Ÿï¼š{device['device_id']}\n"
            cursor.execute("""
                SELECT u.display_name
                FROM users u
                JOIN device_user_map m ON u.id = m.user_id
                WHERE m.device_id = (SELECT id FROM devices WHERE device_id = %s)
            """, (device['device_id'],))
            members = cursor.fetchall()
            names = [m['display_name'] or "åŒ¿åç”¨æˆ¶" for m in members]
            result_msg += f"æˆå“¡ï¼š{', '.join(names)}\n"

        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=result_msg))
        db.close()
        return

    # ä»Šæ—¥å“­è²ç´€éŒ„
    if msg in ["3", "3.", "ä»Šæ—¥å“­è²ç´€éŒ„", "3.ä»Šæ—¥å“­è²ç´€éŒ„", "3. ä»Šæ—¥å“­è²ç´€éŒ„"]:
        logs = get_today_logs_for_user(cursor, user_id)
        if not logs:
            result_msg = "ä»Šå¤©é‚„æ²’æœ‰å“­è²ç´€éŒ„ï¼"
        else:
            result_msg = "ğŸ“Š ä»Šå¤©çš„å“­è²ç´€éŒ„ï¼š\n"
            for log in logs:
                reason = log[1] if isinstance(log, tuple) else log.get('reason') or ''
                cry = (log[0] if isinstance(log, tuple) else log.get('cry_type')) or reason or 'æœªçŸ¥'
                ts = (log[2] if isinstance(log, tuple) else log.get('created_at'))
                hhmm = ts.strftime('%H:%M') if ts else '--:--'
                result_msg += f"- {hhmm}ï¼š{cry}\n"

        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=result_msg))
        db.close()
        return
    
    #Template Message
    @handler.add(MessageEvent, message=TextMessage)
    def handle_message(event):
        user_msg = event.message.text.strip()

    if user_msg in ["4", "4.", "å¯¶å¯¶æ”»ç•¥å¤§å…¨", "4.å¯¶å¯¶æ”»ç•¥å¤§å…¨", "4. å¯¶å¯¶æ”»ç•¥å¤§å…¨"]:
        reply = TemplateSendMessage(
            alt_text='ä¸»é¸å–®',
            template=ButtonsTemplate(
                title='æ–°ç”Ÿå¯¶å¯¶å¿…ä¿®èª²|çˆ¸åª½å®‰å¿ƒçœ‹',
                text='è«‹é¸æ“‡ä»¥ä¸‹åŠŸèƒ½',
                actions=[
                    MessageAction(
                        label='å¯¶å¯¶å¿…å‚™æ¸…å–®',
                        text='ï¼»å¯¶å¯¶å¿…å‚™æ¸…å–®ï¼½\n    æ¡è³¼æ™‚æ©Ÿå»ºè­°åª½åª½åœ¨æ‡·å­•7è‡³8å€‹æœˆæ™‚ï¼Œå…ˆæ ¹æ“šè‡ªèº«é ç®—ï¼Œæ…¢æ…¢åˆ—å‡ºå¬°å…’å‡ºç”Ÿç”¨å“çš„æ¡è²·æ¸…å–®ï¼Œä»¥å…æœ‰éºæ¼ï¼Œæ¥è‘—åœ¨ç”Ÿç”¢å‰2å€‹æœˆå†é€éç¶²è·¯æˆ–ç›´æ¥å‰å¾€å•†å ´é¸è³¼å³å¯ã€‚\n\nğŸš¼å¬°å…’è»Šèˆ‡é…ä»¶\n	â€¢ å¬°å…’èƒŒå¸¶ï¼šå¯å°‡å¯¶å¯¶èƒŒåœ¨èº«ä¸Šï¼Œç©ºå‡ºé›™æ‰‹åšå…¶ä»–äº‹ã€‚å»ºè­°é¸æ“‡å …å›ºã€æ˜“æ¸…æ´—çš„æ¬¾å¼ã€‚\n	â€¢ å¬°å…’æ¨è»Šï¼šæ–¹ä¾¿å¸¶å¯¶å¯¶å¤–å‡ºï¼Œåˆºæ¿€æ„Ÿå®˜ã€è½‰æ›å¿ƒæƒ…ã€‚\n	â€¢ å…’ç«¥æ±½è»Šå®‰å…¨åº§æ¤…ï¼šæ³•å¾‹è¦å®šå¿…å‚™ï¼Œèƒ½ä¿è­·å¯¶å¯¶å®‰å…¨ã€‚æ³¨æ„ä½¿ç”¨å¹´é™ï¼ˆç´„ 5~7 å¹´ï¼‰ï¼Œé¿å…ä½¿ç”¨éæœŸæˆ–äºŒæ‰‹ç”¢å“ã€‚\n\nğŸ¼å“ºä¹³ç”¨å“\n	â€¢ é¤µå¥¶å°ˆç”¨æ•ï¼šæ¸›è¼•æ‰‹è‡‚èˆ‡é ¸éƒ¨è² æ“”ï¼Œå¹«åŠ©å¯¶å¯¶ç¶­æŒè‰¯å¥½å§¿å‹¢ã€‚\n	â€¢ å“ºä¹³å°ç‰©ï¼šç¶¿ç¾Šæ²¹ã€å†°è¢‹å¯èˆ’ç·©è„¹ç—›ï¼›é˜²æº¢ä¹³å¢Šé¿å…è¡£ç‰©æ²¾æ¿•ã€‚\n	â€¢ åœå…œï¼šæ¥ä½å£æ°´æˆ–æº¢å¥¶ã€‚\n	â€¢ å¥¶ç“¶ï¼šå¯é¸ç»ç’ƒæˆ–ä¸é½é‹¼æè³ªï¼Œé¿å…åŒ–å­¸ç‰©è³ªé‡‹å‡ºã€‚\n	â€¢ é…æ–¹å¥¶ï¼šæ¯ä¹³ä¸è¶³æ™‚å¯æ›¿ä»£ï¼Œç¨®é¡å¤šå…ƒï¼Œå»ºè­°èˆ‡é†«å¸«è¨è«–ã€‚\n	â€¢ é›†ä¹³å™¨ï¼šæ”¶é›†ä¹³æ±ï¼Œæœ‰æ‰‹å£“å‹èˆ‡é›»å‹•å‹ã€‚\n	â€¢ æ¯ä¹³å„²å­˜è¢‹ï¼šç¯€çœå†°ç®±ç©ºé–“ï¼Œéƒ¨åˆ†æ¬¾å¼å¯ç›´æ¥è§£å‡ä½¿ç”¨ã€‚\n	â€¢ æ“ ä¹³çµ„ï¼šæ–¹ä¾¿éˆæ´»ï¼Œæ”¯æ´æ¯ä¹³é¤µé¤Šã€‚\n	â€¢ æº«å¥¶å™¨ï¼šå¿«é€Ÿè§£å‡æˆ–åŠ ç†±æ¯ä¹³ã€‚\n	â€¢ å¥¶ç“¶åˆ·ï¼šå¤§å°åˆ·å…·æ­é…ï¼Œæ¸…æ½”æ›´å¾¹åº•ã€‚\n	â€¢ å¥¶ç“¶æ¸…æ½”åŠ‘ï¼šå°ˆç”¨æ¸…æ½”ç”¨å“ï¼Œæˆåˆ†å®‰å…¨ã€‚\n	â€¢ å¥¶ç“¶æ¶ˆæ¯’å™¨ï¼šå¸¸è¦‹æœ‰è’¸æ±½ã€ç´«å¤–ç·šã€åŒ–å­¸æ¶ˆæ¯’ä¸‰ç¨®æ–¹å¼ã€‚\n	â€¢ å¥¶ç²‰èˆ‡å¥¶ç²‰æ”œå¸¶ç›’ï¼šå¤–å‡ºæˆ–æ¯ä¹³ä¸è¶³æ™‚çš„å¥½å¹«æ‰‹ï¼Œæ”œå¸¶ç›’åˆ†å¤§å°å®¹é‡æ–¹ä¾¿ä½¿ç”¨ã€‚\n\nğŸ›æ–°ç”Ÿå…’å¯¢å…·\n	â€¢ æ¯¯å­ï¼šåˆ†ç‚ºå¯ç©¿å¼ã€åŒ…å·¾å¼ï¼Œä¾éœ€æ±‚é¸ç”¨ã€‚\n	â€¢ å¬°å…’åºŠèˆ‡åºŠå¢Šï¼šç¢ºä¿å¯¶å¯¶å®‰å…¨èˆ‡çˆ¶æ¯ç¡çœ å“è³ªï¼Œæ‡‰é¸å®‰å…¨æª¢é©—åˆæ ¼ã€æ˜“æ¸…æ´—æ¬¾å¼ã€‚\n\nğŸ½é¤é£²ç”¨å“\n	â€¢ å…’ç«¥æ¹¯åŒ™ï¼šå¡‘è† æˆ–æ©¡è† æè³ªï¼Œå®‰å…¨åˆæœ‰è¶£ï¼Œå¯å¸å¼•å¯¶å¯¶èˆˆè¶£ã€‚\n	â€¢ å…’ç«¥å°ˆç”¨ç¢—ï¼šå¹«åŠ©å¯¶å¯¶å­¸ç¿’è‡ªå·±é€²é£Ÿã€‚\n	â€¢ å…’ç«¥é¤æ¤…ï¼šé™„æ‰˜ç›¤æ¬¾å¼æ–¹ä¾¿æ¸…æ½”ï¼Œä¹Ÿæœ‰å¯æ‹†å¼æ‰˜ç›¤å¯ç›´æ¥æ´—æ»Œã€‚\n	â€¢ åœå…œï¼šé˜²æ°´å¿«ä¹¾æè³ªèƒ½æ¥ä½æ‰è½é£Ÿç‰©ï¼Œé¿å…ç”¨é¤éå¾Œä¸€åœ˜äº‚ã€‚\n\nğŸ§´ç”Ÿæ´»èˆ‡æ¸…æ½”å¿…å‚™\n	â€¢ å¬°å…’åºŠæˆ–åºŠä¸­åºŠï¼šçµæ§‹éœ€ç‰¢å›ºï¼Œé¿å…éŠ³åˆ©é‚Šè§’ã€‚\n	â€¢ ç´™å°¿å¸ƒï¼šä¾å¯¶å¯¶é«”é‡æŒ‘é¸å°ºå¯¸ï¼ˆNB~XXLï¼‰ã€‚\n	â€¢ å›ºé½’å™¨ï¼šèˆ’ç·©é•·ç‰™ä¸é©ã€‚\n	â€¢ å¥¶å˜´ï¼šå®‰æ’«å¯¶å¯¶æƒ…ç·’ï¼Œå¹«åŠ©å…¥ç¡ã€‚å»ºè­°è³¼è²· 2 å€‹ä»¥ä¸Šæ›¿æ›ã€‚\n	â€¢ å¬°å…’å°ˆç”¨æŒ‡ç”²å‰ªï¼šé¿å…åˆ®å‚·è‚Œè†šã€‚\n	â€¢ é«”æº«è¨ˆï¼è€³æº«æ§ï¼š3 å€‹æœˆå‰å»ºè­°ç”¨é«”æº«è¨ˆï¼Œä¹‹å¾Œå¯ç”¨è€³æº«æ§ã€‚\n	â€¢ å¬°å…’æ¿•ç´™å·¾ï¼šé¸å¤©ç„¶æº«å’Œé…æ–¹ï¼Œå‘µè­·è‚Œè†šã€‚\n\nğŸ›ç›¥æ´—ç”¨å“\n	â€¢ æ¾¡ç›†ï¼šå¤§å°é©ä¸­ï¼Œæ–¹ä¾¿æ¸…æ´—å¯¶å¯¶ã€‚å¯é¸æŠ˜ç–Šå¼ï¼Œæ–¹ä¾¿æ”¶ç´ã€‚\n	â€¢ å¬°å…’å°ˆç”¨æ¸…æ½”ç”¨å“ï¼šé¸ç„¡é¦™ç²¾ã€ç„¡å¡‘åŒ–åŠ‘çš„æº«å’Œé…æ–¹ã€‚\n	â€¢ å¬°å…’ç‰™åˆ·ï¼šé©ç”¨æ–¼ 6 å€‹æœˆå¾Œå‡ºç‰™å¯¶å¯¶ã€‚\n	â€¢ ç´—å¸ƒå·¾ï¼šç”¨é€”å»£ï¼Œå»ºè­°æº–å‚™ 5 æ¢ä»¥ä¸Šã€‚\n	â€¢ æµ´å·¾ï¼šæŸ”è»Ÿå¤§å°ºå¯¸ï¼Œå¯åŒ…è£¹å…¨èº«ã€‚\n\nğŸ²æ—©æ•™æˆ–å…¶ä»–\n	â€¢ ç©å…·ï¼šå»ºè­°é¸æ“‡å®‰å…¨æè³ªï¼Œå¦‚çµ¨æ¯›ç©å¶ã€æ–éˆ´ã€éŸ³æ¨‚å¨ƒå¨ƒã€‚\n	â€¢ ç«¥æ›¸ï¼šå•Ÿç™¼èªè¨€èˆ‡æƒ³åƒåŠ›ï¼Œé¤Šæˆé–±è®€ç¿’æ…£ã€‚\n	â€¢ æ–æ–æ¤…ï¼šèƒ½éš¨å¯¶å¯¶å‹•ä½œæ“ºå‹•ï¼Œä¸¦é™„å®‰å…¨ç¶å¸¶ï¼Œè®“çˆ¶æ¯å¯å®‰å¿ƒè™•ç†å…¶ä»–äº‹ã€‚\n\nåƒè€ƒè³‡æ–™ï¼š\n- https://www.gbding.com/blog/posts/newborn-baby-essentials-shopping-list#section2\n- https://helloyishi.com.tw/parenting/babys-first-year/baby-care/things-to-buy-for-your-newborn/\n- https://www.runnyyolk.com/blog/posts/2024æ–°æ‰‹çˆ¸åª½å¿…çœ‹ï¼å¬°å…’ç”¨å“å¿…å‚™æ¸…å–®ï¼Œè·Ÿè‘—è²·å°±å°äº†'
                    ),
                    MessageAction(
                        label='å¯¶å¯¶ç…§è­·æ”»ç•¥ï¼ˆæŠ±æ³•ã€æ›å°¿å¸ƒç­‰ï¼‰',
                        text='ï¼»å¯¶å¯¶ç…§è­·æ”»ç•¥ï¼½\nä¸€ã€è¦ªé¤µèˆ‡ç“¶é¤µå”åŠ©ï¼š\n  â—è¦ªé¤µå”åŠ©: è¦ªé¤µé›–ç„¶çˆ¸çˆ¸ç„¡æ³•ä»£å‹ï¼Œå»å¯ä»¥å¾æ—å”åŠ©ï¼Œè®“åª½å’ªçš„å“ºä¹³éç¨‹æ›´é †æš¢ã€‚\n    1.èˆ’é©å§¿å‹¢: æº–å‚™å“ºä¹³æ•æˆ–é æ•ï¼Œå”åŠ©å¤ªå¤ªæ‰¾åˆ°èˆ’é©çš„å§¿å‹¢é–‹å§‹å“ºé¤µã€‚\n    2.é˜²æº¢åå¥¶: æº–å‚™ç´—å¸ƒå·¾æˆ–å°æ¯›å·¾ï¼Œä»¥é˜²æº¢åå¥¶æªæ‰‹ä¸åŠã€‚\n    3.å£è…”æ¸…æ½”: å¦‚å¯¶å¯¶æ¸…é†’ç‹€æ³è¨±å¯ï¼Œå–å¥¶å¾Œå»ºè­°å¯ä»¥ç”¨æ‹‹æ£„å¼ç´—å¸ƒæ²¾æ¿•æº«é–‹æ°´ï¼Œå¹«å¯¶å¯¶æ¸…æ½”å£è…”ã€‚\n    4.æŒ‰æ‘©èˆ’ç·©: å¯æ›¿åª½åª½æŒ‰æ‘©é ­çš®èˆ‡è‚©é ¸ï¼Œèˆ’ç·©åª½åª½æƒ…ç·’ã€‚\n  â—ç“¶é¤µå”åŠ©: åª½åª½äº‹å…ˆæ“ å‡ºä¾†ä¿å­˜çš„æ¯å¥¶ï¼Œå°±å¯ä»¥äº¤çµ¦çˆ¸çˆ¸ä¾†é€²è¡Œç“¶é¤µï¼Œè®“åª½åª½å¤šå‡ºæ™‚é–“åšåˆ¥çš„äº‹ã€‚\n    1.è¼•é»å˜´å”‡: å°‡å¥¶ç“¶è¼•é»å¯¶å¯¶å˜´å”‡ï¼Œæ­¤æ™‚å¯¶å¯¶æœƒå¼µå˜´ï¼Œå°‡å¥¶å˜´å®Œæ•´æ”¾å…¥å¯¶å¯¶å£ä¸­ã€‚\n    2.å¥¶ç“¶å‚¾æ–œ: å¥¶ç“¶å‚¾æ–œä½¿å¥¶æ°´å……æ»¿å¥¶å˜´ï¼Œè®“å¯¶å¯¶æŒçºŒå¸å®ä¸æœƒåä¸‹ç©ºæ°£ã€‚\n    3.æš«åœæ‹å—: æ–°ç”Ÿå…’çš„é£²å¥¶é‡æœ‰é™ï¼Œå¯¶å¯¶ä¸æƒ³å–æ™‚ï¼Œå¯è¼•è¼•æ‹å—å¾Œï¼Œå†ç¢ºèªæ˜¯å¦é‚„æƒ³å†å–ã€‚ä¸è¦å¼·è¿«å·²ä¸æƒ³å–å¥¶çš„å¬°å…’æŠŠå‰©ä¸‹çš„å¥¶å–å®Œã€‚\n    4.å£è…”æ¸…æ½”: å¦‚å¯¶å¯¶æ¸…é†’ç‹€æ³è¨±å¯ï¼Œå–å¥¶å¾Œå»ºè­°å¯ä»¥ç”¨æ‹‹æ£„å¼ç´—å¸ƒæ²¾æ¿•æº«é–‹æ°´ï¼Œå¹«å¯¶å¯¶æ¸…æ½”å£è…”ã€‚\n  â˜…å°æé†’: ç“¶é¤µæ™‚è«‹æ³¨æ„å¥¶æ°´æµé€Ÿï¼Œè©¦è‘—å°‡å¥¶ç“¶å€’ç½®ï¼Œå¥¶æ°´ã€Œ1ç§’1æ»´ã€çš„å­”æ´å¤§å°ï¼Œæœ€é©åˆæ–°ç”Ÿå…’å¸å®èˆ‡ååš¥ã€‚\n\näºŒã€æ‹å—ï¼š\n    1.æŠ±å¥½å¯¶å¯¶: è®“å¯¶å¯¶å´èº«ååœ¨å¤§äººè…¿ä¸Šï¼Œçˆ¸çˆ¸ä¸€æ‰‹å¾å‰æ–¹æ‰˜ä½å¯¶å¯¶çš„ä¸‹å·´ã€é ¸éƒ¨èˆ‡è‚©è†€ã€‚\n    2.ç©ºæŒè¼•æ‹: å¦ä¸€æ‰‹å¾®å½å‘ˆç©ºæŒï¼Œåœ¨å¯¶å¯¶èƒŒä¸Šè¼•æ‹ã€‚\n\nä¸‰ã€æ´—æ¾¡Â ï¼š\n    1.æŠ±å¥½å¯¶å¯¶: å°‡å¯¶å¯¶ä»¥æ©„æ¬–çƒå§¿å‹¢å´æŠ±åœ¨è…‹ä¸‹ï¼Œè®“ä»–æ•é åœ¨åŒå´æ‰‹è‡‚ä¸ŠåŒæ™‚æ”¯æ‰˜ä½å¾Œé ¸ï¼Œç”¨å¤§æ‹‡æŒ‡è¼•æŒ‰è€³æœµã€‚\n    2.å…ˆæ´—è‡‰: å¦ä¸€æ‰‹æ‹¿æ´—æ·¨æ“°ä¹¾çš„å¸ƒå·¾è¼•è¼•æ“¦æ´—è‡‰éƒ¨ã€‚\n    3.å†æ´—é ­: æ“ å°‘è¨±æ´—æ²ç”¨å“ï¼Œå¹«å¯¶å¯¶è¼•è¼•æ“æ´—é ­çš®ï¼Œä¸¦ä»¥æ¸…æ°´æ²–æ·¨ï¼Œè¼•è¼•æ“¦ä¹¾ã€‚\n    4.æœ€å¾Œèº«é«”: æœ€å¾Œä¸‹æ°´æ´—èº«é«”ï¼Œç•™æ„å¾Œé ¸ã€è…‹ä¸‹ã€ç”Ÿæ®–å™¨ç­‰çšºè¤¶è™•æ¯”è¼ƒå®¹æ˜“é«’æ±¡ã€‚\n  â˜…æ³¨æ„äº‹é …:\n    â– ç„¡è«–å››å­£ï¼Œæ´—æ¾¡æ™‚å®¤æº«ç¶­æŒåœ¨25-28â„ƒï¼Œæœ€ç‚ºèˆ’é©ã€‚\n    â– å»ºè­°å…ˆæ”¾å†·æ°´å†æ”¾ç†±æ°´ï¼Œç¢ºä¿å¯¶å¯¶å®‰å…¨ã€‚\n    â– æœ€é©åˆçš„æ´—æ¾¡æ°´å¤§ç´„æ˜¯ä»‹æ–¼åœ¨37-38â„ƒå·¦å³ï¼Œå¯ä»¥ç”¨æº«åº¦è¨ˆæ¸¬é‡ã€‚å¦‚å¯¶å¯¶æ´—å®Œæ¾¡å¾Œå…¨èº«ç´…é€šé€šï¼Œæˆ–æ˜¯å‡ºç¾èµ·ç–¹ç™¼ç´…ç¾è±¡ï¼Œè¡¨ç¤ºæ°´å¤ªç†±ï¼Œè«‹é€æ¼¸èª¿é™æ°´æº«æ‰¾åˆ°é©åˆçš„æº«åº¦ã€‚\n    â– é¿å…å¯¶å¯¶å¤ªé¤“æˆ–å¤ªé£½æ™‚æ´—æ¾¡ã€‚\n\nå››ã€æ›å°¿å¸ƒï¼š\n    1.æ´—å±å±: å…ˆç”¨æº«æ¸…æ°´å¹«å¯¶å¯¶æŠŠå±è‚¡æ´—ä¹¾æ·¨(ä¸ä¾¿æ™‚å¯ç”¨æ¿•ç´™å·¾)ã€‚\n    2.é›™è…³èˆ‰é«˜: è®“å¯¶å¯¶èººå¥½ï¼Œä¸€æ‰‹æŠ“ä½é›™è…³èˆ‰é«˜ã€‚\n    3.æ”¾å°¿å¸ƒ: å¦ä¸€æ‰‹å°‡ä¹¾æ·¨å°¿å¸ƒæ”¾åˆ°é©åˆä½ç½®ï¼Œå†å°‡é›™è…³æ”¾ä¸‹ã€‚\n    4.é»å¥½å°¿å¸ƒ: æ’•é–‹å°¿å¸ƒå…©å´çš„é­”é¬¼æ°ˆç¢ºå¯¦é»å¥½ã€‚\n    5.æœ€å¾Œæª¢æŸ¥: ç¢ºèªè…°éƒ¨é¬†ç·Šåº¦æ˜¯å¦åˆå®œï¼Œä¸¦æ•´ç†å¤§è…¿å´é‚Šçš„å°¿å¸ƒã€‚\n\näº”ã€è‡å¸¶è­·ç†ï¼š\n    1.å…ˆæ¶ˆæ¯’: æ»…èŒæ£‰æ£’æ»´ä¸Šé©é‡75ï¼…é…’ç²¾ï¼Œç¹è‘—è‡å¸¶æ ¹éƒ¨ç”±å…§å¾€å¤–ç’°ç‹€æ“¦æ‹­ä¸€åœˆã€‚\n    2.å¾Œä¹¾ç‡¥: å†å–å¦ä¸€æ”¯æ»…èŒæ£‰æ£’ï¼Œæ»´ä¸Šé©é‡95ï¼…é…’ç²¾ï¼Œç¹è‘—è‡å¸¶æ ¹éƒ¨ç”±å…§å¾€å¤–ç’°ç‹€æ“¦æ‹­ä¸€åœˆã€‚\n  â˜…å°æé†’: å¯¶å¯¶è‡å¸¶ç…§é¡§çš„åŸå‰‡æ˜¯ä¿æŒä¹¾æ·¨èˆ‡ä¹¾ç‡¥ï¼Œè«‹çˆ¸åª½å€‘ä¾æ¥ç”Ÿé†«é™¢ä¹‹æ•™å°ï¼Œé€²è¡Œè‡å¸¶è­·ç†ã€‚è‡å¸¶æœªè„«è½å‰æ‡‰è®“å¯¶å¯¶ç©¿è‘—å¯¬é¬†è¡£ç‰©ï¼Œä¸¦å°‡å°¿å¸ƒåæ‘ºï¼Œä½¿è‡éƒ¨ä¿æŒä¹¾ç‡¥ï¼Œè‹¥æœ‰é•·æ¯è‚‰æˆ–æ˜¯åˆ†æ³Œç‰©æƒ¡è‡­ã€å‘¨åœçš®è†šç´…è…«ç­‰è‡å¸¶ç‚çš„ç¾è±¡ï¼Œå‰‡è«‹è¿”å›é†«é™¢è¨ºæ²»ã€‚\n\nåƒè€ƒè³‡æ–™ï¼š\n- https://mammy.hpa.gov.tw/Home/NewsKBContent?id=2403&type=01\n- https://www.cmuh.cmu.edu.tw/HealthEdus/Detail?no=5220#:~:text=æ–°ç”Ÿå…’å±…å®¶æ³¨æ„äº‹é …%20*%20å…ˆå°‡åŒ…å¸ƒã€è¡£æœé‹ªå¥½ï¼Œä¸¦å°‡å¤§æ¯›å·¾æ”¾ç½®èº«æ—ä»¥ä¾¿å–ç”¨%E3%80%82%20*%20æ”¾å†·æ°´å†æ”¾ç†±æ°´ï¼Œä»¥æ‰‹è‚˜ã€æ‰‹è…•å…§å´è©¦æ°´æº«ï¼Œä»¥ä¸ç‡™æ‰‹ç‚ºåŸå‰‡ï¼Œæº«åº¦40%20â„ƒ%20å·¦å³%E3%80%82%20*%20é¤µé£Ÿå¾Œä¸€å°æ™‚å‹¿æ´—æ¾¡ï¼Œè‹¥å¤©æ°£å¯’å†·æ™‚ï¼Œé¸æ“‡ä¸€å¤©ä¸­æ°£æº«è¼ƒé«˜çš„æ™‚æ®µç‚ºä½³%E3%80%82%20*%20é ¸éƒ¨ã€è…‹ä¸‹ã€è…¹è‚¡æºã€ç”Ÿæ®–éƒ¨éƒ½è¦æ¸…æ´—ä¹¾æ·¨%E3%80%82%20*%20å¯æ–¼æ²æµ´å¾Œå¹«å¯¶å¯¶åšè‡å¸¶è­·ç†%E3%80%82\n- https://www.fhs.gov.hk/tc_chi/health_professional/OMP_eNewsletter/enews_20111031.html\n\nå»¶ä¼¸è³‡æ–™ï¼š\n- ã€Œåœ‹æ°‘å¥åº·ç½²ã€-æ¯ä¹³å“ºè‚²æ‰‹å†Š https://reurl.cc/jDKvRm\n- ã€Œç¤¾æœƒåŠå®¶åº­ç½²ã€-ã„œ!æˆ‘æ‰“å—äº† https://reurl.cc/mDK0M7\n- ã€Œç¤¾æœƒåŠå®¶åº­ç½²ã€-å¯¶å¯¶æ´—æ¾¡å’Œæ¸…æ½” https://reurl.cc/94mR3n\n- é«˜éœ€æ±‚å¯¶å¯¶çš„ç…§è­· https://www.chick.com.tw/baike-detail/è‚²å…’è³‡è¨Šç«™/å¯¶å¯¶å±…å®¶ç…§é¡§/high_need_baby?srsltid=AfmBOoroHnD-cSvXzJQ9HnxU_XhanMrHka7-Je5da2NJvulUeVNWMwP_'
                    ),
                    MessageAction(
                        label='å¯¶å¯¶ç–«è‹—æ¥ç¨®æŒ‡å—',
                        text='ï¼»å¯¶å¯¶ç–«è‹—æ¥ç¨®å¤§å…¨ï¼½\nBå‹è‚ç‚ç–«è‹—ï¼šå‡ºç”Ÿæ»¿ä¸€å€‹æœˆæ¥ç¨®ã€‚\nå¡ä»‹è‹—ï¼šå»ºè­°åœ¨å‡ºç”Ÿæ»¿ä¸€å€‹æœˆå¾Œæ¥ç¨®ã€‚\näº”åˆä¸€ç–«è‹—ï¼šåŒ…å«ç™½å–‰ã€ç ´å‚·é¢¨ã€éç´°èƒæ€§ç™¾æ—¥å’³ã€bå‹å—œè¡€æ¡¿èŒåŠä¸æ´»åŒ–å°å…’éº»ç—ºã€‚\n13åƒ¹çµåˆå‹è‚ºç‚éˆçƒèŒç–«è‹—ï¼šæä¾›å¤šç¨®è‚ºç‚éˆçƒèŒè¡€æ¸…å‹çš„ä¿è­·ã€‚\næ°´ç—˜ç–«è‹—ï¼šé é˜²æ°´ç—˜æ„ŸæŸ“ã€‚\néº»ç–¹ã€è…®è…ºç‚ã€å¾·åœ‹éº»ç–¹æ··åˆç–«è‹—(MMR)ï¼šé é˜²ä¸‰ç¨®ç–¾ç—…ã€‚\nAå‹è‚ç‚ç–«è‹—ï¼šé é˜²Aå‹è‚ç‚æ„ŸæŸ“ã€‚\næ—¥æœ¬è…¦ç‚ç–«è‹—ï¼šé é˜²æ—¥æœ¬è…¦ç‚æ„ŸæŸ“ã€‚\n\nå¸¸è¦‹å‰¯ä½œç”¨ï¼šå¯èƒ½çš„å‰¯ä½œç”¨å¦‚æ³¨å°„éƒ¨ä½å±€éƒ¨ç–¼ç—›æˆ–è¼•å¾®ç™¼ç‡’ï¼Œé€šå¸¸æœƒåœ¨æ¥ç¨®å¾Œå¹¾å¤©å…§æ¶ˆé€€ã€‚\n\nåƒè€ƒè³‡æ–™ï¼š\n- https://nestlebaby.hk/content/0-è‡³2-æ­²æ¥ç¨®ç–«è‹—æ™‚é–“è¡¨\n- https://kids.heho.com.tw/archives/154606\n- https://www.carloine.com.tw/Article/Detail/78265?gad_source=1&gad_campaignid=19750688572&gbraid=0AAAAACyIkX45uEdr7U6s2XdHIP3_-MZS9&gclid=Cj0KCQjwrJTGBhCbARIsANFBfgvnwu-0E9c5iSS4DX4yn0UW-VY7tTz6pkvlktHPA0nlwHJxNM18kNMaAu3tEALw_wcB'
                    )
                ]
            )
        )
        line_bot_api.reply_message(event.reply_token, reply)